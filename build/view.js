(()=>{function initCalculator(calculator){const stepsData=JSON.parse(calculator.dataset.steps||"[]"),priceCalculation=JSON.parse(calculator.dataset.priceCalculation||'{"enabled":false}'),productId=calculator.dataset.productId||0;let currentStep=0,formData={},uploadedFiles={};const contentArea=calculator.querySelector(".calculator-content"),prevButton=calculator.querySelector(".btn-previous"),nextButton=calculator.querySelector(".btn-next"),priceDisplay=calculator.querySelector(".calculator-price");function renderStep(e){const t=stepsData[e];if(!t)return;currentStep=e,calculator.querySelectorAll(".step-indicator").forEach(function(t,a){t.classList.remove("active","completed"),a===e?t.classList.add("active"):a<e&&t.classList.add("completed")});const a=calculator.querySelector(".progress-line");if(a){const t=e/(stepsData.length-1)*100;a.style.width=t+"%"}let r='<h3 class="step-title">'+escapeHtml(t.title)+"</h3>";r+='<div class="calculator-fields">',t.fields.forEach(function(e){r+=renderField(e)}),r+="</div>",contentArea.innerHTML=r,attachFieldListeners(t.fields),updateNavigation(),priceCalculation.enabled&&updatePrice()}function renderField(e){const t=formData[e.name]||"",a=e.required?'<span class="required">*</span>':"";let r='<div class="field-group" data-field-name="'+e.name+'">';switch(r+="<label>"+escapeHtml(e.label)+a+"</label>",e.type){case"text":case"number":const a=e.type,n=e.min?' min="'+e.min+'"':"",c=e.max?' max="'+e.max+'"':"",o=e.step?' step="'+e.step+'"':"";r+='<input type="'+a+'" name="'+e.name+'" value="'+escapeHtml(t)+'"'+n+c+o+" />";break;case"textarea":r+='<textarea name="'+e.name+'">'+escapeHtml(t)+"</textarea>";break;case"select":r+='<select name="'+e.name+'">',r+='<option value="">Select an option</option>',(e.options||[]).forEach(function(e){const a=t===e.value?" selected":"";r+='<option value="'+escapeHtml(e.value)+'"'+a+">"+escapeHtml(e.label)+"</option>"}),r+="</select>";break;case"radio":r+='<div class="radio-group">',(e.options||[]).forEach(function(a){const n=t===a.value?" checked":"";r+='<label><input type="radio" name="'+e.name+'" value="'+escapeHtml(a.value)+'"'+n+" /> "+escapeHtml(a.label)+"</label>"}),r+="</div>";break;case"checkbox":r+='<div class="checkbox-group">',(e.options||[]).forEach(function(a){const n=Array.isArray(t)&&t.includes(a.value)?" checked":"";r+='<label><input type="checkbox" name="'+e.name+'[]" value="'+escapeHtml(a.value)+'"'+n+" /> "+escapeHtml(a.label)+"</label>"}),r+="</div>";break;case"file":const l=uploadedFiles[e.name]?uploadedFiles[e.name].name:"No file chosen",i=uploadedFiles[e.name]?" has-file":"";r+='<div class="file-upload'+i+'" data-field="'+e.name+'">',r+='<div class="upload-icon">üìÅ</div>',r+='<div class="upload-text">Click to upload or drag and drop</div>',r+='<div class="file-info">Accepted: PDF, PNG, JPG, AI, EPS (Max 10MB)</div>',r+='<div class="file-name">'+l+"</div>",r+='<input type="file" name="'+e.name+'" accept=".pdf,.png,.jpg,.jpeg,.ai,.eps" />',r+="</div>"}return r+='<div class="error-message"></div>',r+="</div>",r}function attachFieldListeners(e){e.forEach(function(e){const t=contentArea.querySelector('[data-field-name="'+e.name+'"]');if(t)if("file"===e.type){const a=t.querySelector(".file-upload"),r=t.querySelector('input[type="file"]');a.addEventListener("click",function(){r.click()}),r.addEventListener("change",function(t){handleFileUpload(t.target,e.name)}),a.addEventListener("dragover",function(e){e.preventDefault(),a.classList.add("dragover")}),a.addEventListener("dragleave",function(){a.classList.remove("dragover")}),a.addEventListener("drop",function(t){t.preventDefault(),a.classList.remove("dragover"),r.files=t.dataTransfer.files,handleFileUpload(r,e.name)})}else if("checkbox"===e.type){const a=t.querySelectorAll('input[type="checkbox"]');a.forEach(function(t){t.addEventListener("change",function(){const t=Array.from(a).filter(e=>e.checked).map(e=>e.value);formData[e.name]=t,priceCalculation.enabled&&updatePrice()})})}else{const a=t.querySelector("input, select, textarea");a&&a.addEventListener("change",function(){formData[e.name]=this.value,clearError(e.name),priceCalculation.enabled&&updatePrice()})}})}function handleFileUpload(e,t){const a=e.files[0];if(!a)return;if(!["application/pdf","image/png","image/jpeg","image/jpg"].includes(a.type)&&!a.name.match(/\.(ai|eps)$/i))return void showError(t,"Invalid file type. Please upload PDF, PNG, JPG, AI, or EPS.");if(a.size>10485760)return void showError(t,"File size exceeds 10MB limit.");const r=e.closest(".file-upload");r.classList.add("uploading");const n=new FormData;n.append("file",a),n.append("action","woo_calculator_upload_file"),n.append("nonce",wooCalculatorData.nonce),fetch(wooCalculatorData.ajaxUrl,{method:"POST",body:n}).then(e=>e.json()).then(e=>{r.classList.remove("uploading"),e.success?(uploadedFiles[t]={name:a.name,url:e.data.url},r.classList.add("has-file"),r.querySelector(".file-name").textContent=a.name,n[t]=e.data.url,clearError(t)):showError(t,e.data.message||"Upload failed")}).catch(e=>{r.classList.remove("uploading"),showError(t,"Upload failed. Please try again.")})}function validateStep(e){const t=stepsData[e];let a=!0;return t.fields.forEach(function(e){if(e.required){const t=formData[e.name];(!t||Array.isArray(t)&&0===t.length)&&(showError(e.name,"This field is required"),a=!1)}}),a}function showError(e,t){const a=contentArea.querySelector('[data-field-name="'+e+'"]');if(a){const e=a.querySelector("input, select, textarea");e&&e.classList.add("error");const r=a.querySelector(".error-message");r&&(r.textContent=t)}}function clearError(e){const t=contentArea.querySelector('[data-field-name="'+e+'"]');if(t){const e=t.querySelector("input, select, textarea");e&&e.classList.remove("error");const a=t.querySelector(".error-message");a&&(a.textContent="")}}function updateNavigation(){prevButton.disabled=0===currentStep,currentStep===stepsData.length-1?nextButton.textContent=calculator.dataset.buttonText||"Add to Cart":nextButton.textContent="Next"}function updatePrice(){if(priceCalculation.enabled&&priceCalculation.formula)try{let formula=priceCalculation.formula;Object.keys(formData).forEach(function(e){const t=parseFloat(formData[e])||0;formula=formula.replace(new RegExp(e,"g"),t)});const price=eval(formula);priceDisplay&&!isNaN(price)&&(priceDisplay.querySelector(".price-amount").textContent="$"+price.toFixed(2))}catch(e){console.error("Price calculation error:",e)}}function submitCalculator(){contentArea.innerHTML='<div class="calculator-loading"><div class="spinner"></div><p>Adding to cart...</p></div>';const e=new FormData;e.append("action","woo_calculator_add_to_cart"),e.append("nonce",wooCalculatorData.nonce),e.append("product_id",productId),e.append("quantity",formData.quantity||1),e.append("calculator_data",JSON.stringify(formData)),fetch(wooCalculatorData.ajaxUrl,{method:"POST",body:e}).then(e=>e.json()).then(e=>{e.success?contentArea.innerHTML='<div class="calculator-success"><div class="success-icon">‚úì</div><h3>Added to Cart!</h3><p>'+e.data.message+'</p><a href="'+e.data.cart_url+'" class="view-cart-btn">View Cart</a></div>':(contentArea.innerHTML='<div class="calculator-error"><p>Error: '+e.data.message+'</p><button class="btn-primary btn-retry">Try Again</button></div>',contentArea.querySelector(".btn-retry").addEventListener("click",function(){renderStep(currentStep)}))}).catch(e=>{contentArea.innerHTML='<div class="calculator-error"><p>An error occurred. Please try again.</p><button class="btn-primary btn-retry">Try Again</button></div>',contentArea.querySelector(".btn-retry").addEventListener("click",function(){renderStep(currentStep)})})}prevButton.addEventListener("click",function(){currentStep>0&&renderStep(currentStep-1)}),nextButton.addEventListener("click",function(){validateStep(currentStep)&&(currentStep<stepsData.length-1?renderStep(currentStep+1):submitCalculator())}),renderStep(0)}function escapeHtml(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}document.addEventListener("DOMContentLoaded",function(){document.querySelectorAll(".wp-block-telex-woo-product-calculator").forEach(function(e){initCalculator(e)})})})();